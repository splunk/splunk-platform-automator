---
# Destroy AWS infrastructure managed by Terraform

- name: Destroy AWS Infrastructure with Terraform
  hosts: localhost
  gather_facts: false
  vars:
    config_file: "{{ lookup('env', 'SPLUNK_CONFIG_FILE') | default('../config/splunk_config.yml', true) }}"
    terraform_dir: "{{ playbook_dir }}/../terraform/aws"

  tasks:
    - name: Load Splunk configuration
      ansible.builtin.include_vars:
        file: "{{ config_file }}"
      tags: always

    - name: Set AWS credentials from config if provided
      ansible.builtin.set_fact:
        terraform_env:
          AWS_ACCESS_KEY_ID: "{{ terraform.aws.access_key_id }}"
          AWS_SECRET_ACCESS_KEY: "{{ terraform.aws.secret_access_key }}"
      when:
        - terraform is defined
        - terraform.aws is defined
        - terraform.aws.access_key_id is defined
        - terraform.aws.secret_access_key is defined
      tags: always
    - name: Check if Terraform state exists
      ansible.builtin.stat:
        path: "{{ terraform_dir }}/terraform.tfstate"
      register: tfstate

    - name: Warn if no state file found
      ansible.builtin.debug:
        msg: "No Terraform state file found. Nothing to destroy."
      when: not tfstate.stat.exists

    - name: Confirm Terraform Destroy
      ansible.builtin.pause:
        prompt: "WARNING: This will destroy all Terraform-managed infrastructure. Press Enter to continue or Ctrl+C to cancel"
      when:
        - tfstate.stat.exists
        - not (auto_approve | default(false) | bool)

    - name: Destroy Terraform Infrastructure
      community.general.terraform:
        project_path: "{{ terraform_dir }}"
        state: absent
      environment: "{{ terraform_env | default({}) }}"
      register: terraform_destroy
      when: tfstate.stat.exists

    - name: Remove generated files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ playbook_dir }}/../inventory/hosts"
        - "{{ terraform_dir }}/tfplan"
      when: tfstate.stat.exists

    - name: Display Destroy Results
      ansible.builtin.debug:
        msg: "Infrastructure destroyed successfully"
      when:
        - tfstate.stat.exists
        - terraform_destroy is succeeded
