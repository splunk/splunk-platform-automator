---
# Provision AWS infrastructure using Terraform
# This playbook generates terraform.tfvars from splunk_config.yml and runs Terraform

- name: Provision AWS Infrastructure with Terraform
  hosts: localhost
  gather_facts: false
  vars:
    config_file: "{{ lookup('env', 'SPLUNK_CONFIG_FILE') | default('../config/splunk_config.yml', true) }}"
    terraform_dir: "{{ playbook_dir }}/../terraform/aws"

  tasks:
    - name: Load Splunk configuration
      ansible.builtin.include_vars:
        file: "{{ config_file }}"
      tags:
        - always

    - name: Load AWS defaults
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../defaults/aws.yml"
        name: default_config
      tags:
        - always

    - name: Validate terraform section exists
      ansible.builtin.assert:
        that:
          - terraform is defined
          - terraform.aws is defined
        fail_msg: "terraform.aws section is required in {{ config_file }}"
      tags:
        - always

    - name: Set AWS credentials from config if provided
      ansible.builtin.set_fact:
        terraform_env:
          AWS_ACCESS_KEY_ID: "{{ terraform.aws.access_key_id }}"
          AWS_SECRET_ACCESS_KEY: "{{ terraform.aws.secret_access_key }}"
      when:
        - terraform.aws.access_key_id is defined
        - terraform.aws.secret_access_key is defined
      tags:
        - always

    - name: Generate terraform.tfvars from template
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../template/terraform_aws.tfvars.j2"
        dest: "{{ terraform_dir }}/terraform.tfvars"
        mode: '0644'
      tags:
        - generate
        - always

    - name: Display generated terraform.tfvars
      ansible.builtin.debug:
        msg: "Generated {{ terraform_dir }}/terraform.tfvars from {{ config_file }}"
      tags: generate

    - name: Run Terraform Plan
      community.general.terraform:
        project_path: "{{ terraform_dir }}"
        state: planned
        plan_file: "{{ terraform_dir }}/tfplan"
        force_init: true
      environment: "{{ terraform_env | default({}) }}"
      register: terraform_plan
      tags:
        - plan
        - apply

    - name: Display Terraform Plan
      ansible.builtin.debug:
        msg: "{{ terraform_plan.stdout.split('\n') }}"
      when: terraform_plan.stdout is defined
      tags:
        - plan
        - apply

    - name: Confirm Terraform Apply
      ansible.builtin.pause:
        prompt: "Review the plan above. Press Enter to apply or Ctrl+C to cancel"
      when:
        - terraform_plan is defined
        - not (auto_approve | default(false) | bool)
      tags: apply

    - name: Apply Terraform Configuration
      community.general.terraform:
        project_path: "{{ terraform_dir }}"
        state: present
      environment: "{{ terraform_env | default({}) }}"
      register: terraform_apply
      tags: apply

    - name: Get Terraform Outputs
      community.general.terraform:
        project_path: "{{ terraform_dir }}"
        state: present
      environment: "{{ terraform_env | default({}) }}"
      register: terraform_outputs
      tags:
        - apply
        - outputs

    - name: Generate Ansible inventory from Terraform outputs
      ansible.builtin.copy:
        content: |
          # Ansible Inventory - Generated from Terraform
          # DO NOT EDIT - This file is auto-generated by provision_terraform_aws.yml

          {% for hostname, details in (terraform_outputs.outputs.ansible_inventory.value | from_json).items() %}
          {{ hostname }} ansible_host={{ details.public_ip }} ansible_user={{ details.ansible_user }} ansible_ssh_private_key_file={{ details.ansible_ssh_private_key_file }} ip_addr={{ details.private_ip }} private_ip={{ details.private_ip }} public_dns_name={{ details.public_dns_name }} private_dns_name={{ details.private_dns_name }}

          {% endfor %}
        dest: "{{ playbook_dir }}/../inventory/hosts"
        mode: '0644'
      when: terraform_outputs.outputs.ansible_inventory is defined
      register: inventory_result
      tags:
        - apply
        - outputs

    - name: Confirm inventory generation
      ansible.builtin.debug:
        msg: "✅ Generated Ansible inventory at {{ playbook_dir }}/../inventory/hosts"
      when:
        - terraform_outputs.outputs.ansible_inventory is defined
        - inventory_result is changed
      tags:
        - apply
        - outputs

    - name: Build provisioned hosts message
      ansible.builtin.set_fact:
        provisioned_hosts_msg: |
          Provisioned {{ (terraform_outputs.outputs.ansible_inventory.value | from_json) | length }} instances:
          {% for host, details in (terraform_outputs.outputs.ansible_inventory.value | from_json).items() %}
            - {{ host }}: {{ details.public_ip }}
          {% endfor %}
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs

    - name: Display Provisioned Hosts
      ansible.builtin.debug:
        msg: "{{ provisioned_hosts_msg.split('\n') }}"
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs

    - name: Set facts for subsequent playbooks
      ansible.builtin.set_fact:
        terraform_ansible_inventory: "{{ terraform_outputs.outputs.ansible_inventory.value | from_json }}"
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs

    - name: Build instance readiness message
      ansible.builtin.set_fact:
        instance_readiness_msg: |
          ✅ Terraform has verified all instances passed AWS status checks.
          Instance States:
          {% for hostname, state in (terraform_outputs.outputs.instance_states.value).items() %}
            - {{ hostname }}: {{ state.state }} ({{ state.public_ip }})
          {% endfor %}
      when: terraform_outputs.outputs.instance_states is defined
      tags:
        - apply
        - outputs

    - name: Display instance readiness status
      ansible.builtin.debug:
        msg: "{{ instance_readiness_msg.split('\n') }}"
      when: terraform_outputs.outputs.instance_states is defined
      tags:
        - apply
        - outputs

    - name: Quick SSH verification (optional)
      ansible.builtin.wait_for:
        host: "{{ item.value.public_ip }}"
        port: 22
        delay: 2
        timeout: 60 # Reduced timeout since Terraform already waited for status checks
        state: started
        msg: "SSH port 22 not available on {{ item.key }} ({{ item.value.public_ip }})"
      loop: "{{ (terraform_outputs.outputs.ansible_inventory.value | from_json) | dict2items }}"
      loop_control:
        label: "{{ item.key }} ({{ item.value.public_ip }})"
      when:
        - terraform_outputs.outputs.ansible_inventory is defined
        - verify_ssh | default(false) | bool
      tags:
        - apply
        - verify

    - name: Build completion message
      ansible.builtin.set_fact:
        completion_msg: |
          ✅ Infrastructure provisioning complete!
          Terraform has verified all instances passed AWS status checks.
          Instances are ready for Ansible deployment.
          Next steps:
            1. (Optional) Comprehensive readiness check: ansible-playbook ansible/wait_for_terraform_aws_hosts.yml
            2. Deploy Splunk: ansible-playbook ansible/deploy_site.yml
          Tip: To enable quick SSH verification during provisioning, use: -e verify_ssh=true
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs

    - name: Display completion message
      ansible.builtin.debug:
        msg: "{{ completion_msg.split('\n') }}"
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs
