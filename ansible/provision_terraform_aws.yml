---
# Provision AWS infrastructure using Terraform
# This playbook generates terraform.tfvars from splunk_config.yml and runs Terraform

- name: Provision AWS Infrastructure with Terraform
  hosts: localhost
  gather_facts: false
  vars:
    config_file: "{{ lookup('env', 'SPLUNK_CONFIG_FILE') | default('../config/splunk_config.yml', true) }}"
    terraform_dir: "{{ playbook_dir }}/../terraform/aws"

  tasks:
    - name: Load Splunk configuration
      ansible.builtin.include_vars:
        file: "{{ config_file }}"
      tags:
        - always

    - name: Validate terraform section exists
      ansible.builtin.assert:
        that:
          - terraform is defined
          - terraform.aws is defined
        fail_msg: "terraform.aws section is required in {{ config_file }}"
      tags:
        - always

    - name: Set AWS credentials from config if provided
      ansible.builtin.set_fact:
        terraform_env:
          AWS_ACCESS_KEY_ID: "{{ terraform.aws.access_key_id }}"
          AWS_SECRET_ACCESS_KEY: "{{ terraform.aws.secret_access_key }}"
      when:
        - terraform.aws.access_key_id is defined
        - terraform.aws.secret_access_key is defined
      tags:
        - always

    - name: Generate terraform.tfvars from template
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../template/terraform_aws.tfvars.j2"
        dest: "{{ terraform_dir }}/terraform.tfvars"
        mode: "0644"
      tags:
        - generate
        - always

    - name: Display generated terraform.tfvars
      ansible.builtin.debug:
        msg: "Generated {{ terraform_dir }}/terraform.tfvars from {{ config_file }}"
      tags: generate

    - name: Initialize Terraform
      community.general.terraform:
        project_path: "{{ terraform_dir }}"
        force_init: true
      environment: "{{ terraform_env | default({}) }}"
      register: terraform_init
      tags:
        - init
        - plan
        - apply

    - name: Run Terraform Plan
      community.general.terraform:
        project_path: "{{ terraform_dir }}"
        state: planned
        plan_file: "{{ terraform_dir }}/tfplan"
      environment: "{{ terraform_env | default({}) }}"
      register: terraform_plan
      tags:
        - plan
        - apply

    - name: Display Terraform Plan
      ansible.builtin.debug:
        var: terraform_plan.stdout
      when: terraform_plan.stdout is defined
      tags:
        - plan
        - apply

    - name: Confirm Terraform Apply
      ansible.builtin.pause:
        prompt: "Review the plan above. Press Enter to apply or Ctrl+C to cancel"
      when:
        - terraform_plan is defined
        - not (auto_approve | default(false) | bool)
      tags: apply

    - name: Apply Terraform Configuration
      community.general.terraform:
        project_path: "{{ terraform_dir }}"
        state: present
      environment: "{{ terraform_env | default({}) }}"
      register: terraform_apply
      tags: apply

    - name: Get Terraform Outputs
      community.general.terraform:
        project_path: "{{ terraform_dir }}"
        state: present
      environment: "{{ terraform_env | default({}) }}"
      register: terraform_outputs
      tags:
        - apply
        - outputs

    - name: Build custom variables lookup from splunk_config.yml
      ansible.builtin.set_fact:
        custom_vars_by_host: |
          {%- set result = {} -%}
          {%- set global_custom = custom | default({}) -%}
          {%- for host in splunk_hosts -%}
            {%- if host.name is defined -%}
              {%- set hostnames = [host.name] -%}
            {%- elif host.list is defined -%}
              {%- set hostnames = host.list -%}
            {%- elif host.iter is defined -%}
              {%- set range_parts = host.iter.numbers.split('..') -%}
              {%- set start_num = range_parts[0] | int -%}
              {%- set end_num = range_parts[1] | int -%}
              {%- set width = range_parts[1] | length -%}
              {%- set hostnames = [] -%}
              {%- for num in range(start_num, end_num + 1) -%}
                {%- set padded_num = "%0{}d".format(width) | format(num) -%}
                {%- set hostname = (host.iter.prefix | default('')) ~ padded_num ~ (host.iter.postfix | default('')) -%}
                {%- set _ = hostnames.append(hostname) -%}
              {%- endfor -%}
            {%- endif -%}
            {%- for hostname in hostnames -%}
              {%- set merged_custom = global_custom | combine(host.custom | default({})) -%}
              {%- if merged_custom | length > 0 -%}
                {%- set _ = result.update({hostname: merged_custom}) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
          {{ result }}
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs

    - name: Generate Ansible inventory from Terraform outputs
      ansible.builtin.copy:
        content: |
          # Ansible Inventory - Generated from Terraform
          # DO NOT EDIT - This file is auto-generated by provision_terraform_aws.yml

          {% for hostname, details in (terraform_outputs.outputs.ansible_inventory.value | from_json).items() %}
          {%   set custom = (custom_vars_by_host | from_yaml).get(hostname, {}) %}
          {{ hostname }} ansible_host={{ details.public_ip }} ansible_user={{ details.ansible_user }} ansible_ssh_private_key_file={{ details.ansible_ssh_private_key_file }}{% if custom.ansible_port is defined %} ansible_port={{ custom.ansible_port }}{% endif %} private_ip={{ details.private_ip }} public_dns_name={{ details.public_dns_name }} private_dns_name={{ details.private_dns_name }}{% for key, value in custom.items() %}{% if key != 'ansible_port' %} {{ key }}={{ value }}{% endif %}{% endfor %}

          {% endfor %}
        dest: "{{ playbook_dir }}/../inventory/hosts"
        mode: "0644"
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs

    - name: Display Provisioned Hosts
      ansible.builtin.debug:
        msg: |
          Provisioned {{ (terraform_outputs.outputs.ansible_inventory.value | from_json) | length }} instances:
          {% for host, details in (terraform_outputs.outputs.ansible_inventory.value | from_json).items() %}
          - {{ host }}: {{ details.public_ip }}
          {% endfor %}
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs

    - name: Set facts for subsequent playbooks
      ansible.builtin.set_fact:
        terraform_ansible_inventory: "{{ terraform_outputs.outputs.ansible_inventory.value | from_json }}"
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs

    - name: Wait for SSH to be available on all hosts
      ansible.builtin.wait_for:
        host: "{{ item.value.public_ip }}"
        port: "{{ item.value.ansible_port | default(22) }}"
        delay: 5
        timeout: 300
        state: started
        msg: "SSH port {{ item.value.ansible_port | default(22) }} not available on {{ item.key }} ({{ item.value.public_ip }})"
      loop: "{{ (terraform_outputs.outputs.ansible_inventory.value | from_json) | dict2items }}"
      loop_control:
        label: "{{ item.key }} ({{ item.value.public_ip }})"
      when:
        - terraform_outputs.outputs.ansible_inventory is defined
        - wait_for_ssh | default(true) | bool
      tags:
        - apply
        - wait

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          âœ… Infrastructure provisioning complete!

          {% if wait_for_ssh | default(true) | bool %}
          All hosts are ready for Ansible provisioning.
          {% else %}
          Note: SSH readiness check was skipped. Run 'ansible-playbook ansible/wait_for_terraform_aws_hosts.yml' to verify.
          {% endif %}

          Next steps:
            1. Verify host readiness: ansible-playbook ansible/wait_for_terraform_aws_hosts.yml
            2. Deploy Splunk: ansible-playbook ansible/deploy_site.yml
      when: terraform_outputs.outputs.ansible_inventory is defined
      tags:
        - apply
        - outputs
