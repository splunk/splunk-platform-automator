---
# Main playbook for this role

- name: Start role tasks
  tags:
    - splunk
    - indexer
  ansible.builtin.debug:
    msg: "role '{{ role_name }}' start"

#TODO: create volume directories
#- name: create volume directories
#  tags:
#    - splunk
#    - indexer
#    - create_volume_path
#  file:
#    path: "{{ item.value.path }}"
#    state: directory
#    owner: "{{splunk_user}}"
#    group: "{{splunk_group}}"
#    mode: 0755
#  loop: "{{ splunk_indexer_volumes | dict2items }}"
#  when: splunk_indexer_volumes_local|length > 0

- name: Check volume pathes
  tags:
    - splunk
    - indexer
    - check_volume_path
  ansible.builtin.include_tasks: check_volume_path.yml
  loop: "{{ splunk_indexer_volumes_local | dict2items }}"
  vars:
    volume_name: "{{ item.key }}"
    volume_path: "{{ item.value.path|default(splunk_home+'/var/lib/splunk') }}"
  when: splunk_indexer_volumes_local|length > 0

- name: Install certs for inputs ssl
  tags:
    - splunk
    - splunk_baseconfig
    - indexer
    - idxsingle
    - idxcluster
    - inputs_ssl
  ansible.builtin.include_role:
    name: baseconfig_app
    tasks_from: splunk_ssl_inputs_certs
  when: splunk_ssl.inputs.enable == true and splunk_ssl.inputs.own_certs == true

- include_tasks: idxcluster.yml
  when: idxc_name is defined

- include_tasks: idxsingle.yml
  when: idxc_name is not defined
