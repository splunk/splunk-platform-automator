---
# Deployer Apps - Runs on deployer hosts
# Calculates and deploys apps that should be distributed via deployer
# Note: apps_common dependency handles config merging

- name: Initialize deployer apps list
  tags:
    - splunk
    - splunk_apps
    - deployer
  ansible.builtin.set_fact:
    deployer_apps: []

- name: Filter apps for deployer distribution
  tags:
    - splunk
    - splunk_apps
    - deployer
  ansible.builtin.set_fact:
    deployer_apps: "{{ deployer_apps + [item] }}"
  loop: "{{ splunk_app_deployment.apps | default([]) }}"
  when:
    - item.deployment_target | default('auto') != 'direct'
    - >-
      (item.premium_app | default('')) == 'itsi' and (
        (item.target_roles is defined and item.target_roles | intersect(['search_head']) | length > 0)
        or (item.target_roles is not defined and groups.role_search_head | default([]) | length > 0)
      ) and (item.itsi_shc_name is not defined or inventory_hostname in (groups['shcluster_' + item.itsi_shc_name] | default([])))
      or (
        item.target_roles is defined
        and item.target_roles | intersect(['search_head']) | length > 0
      )

- name: Debug deployer apps
  tags:
    - splunk
    - splunk_apps
    - deployer
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "DEPLOYER: {{ inventory_hostname }}"
      - "========================================="
      - "Total apps for deployer distribution: {{ deployer_apps | length }}"
      - "Apps: {{ deployer_apps | map(attribute='name') | list | join(', ') if deployer_apps | length > 0 else '(none)' }}"
      - "========================================="
    verbosity: 0

- name: Process deployer apps
  tags:
    - splunk
    - splunk_apps
    - deployer
  block:
    - name: Process each deployer app
      ansible.builtin.include_tasks: "process_deployer_app.yml"
      loop: "{{ deployer_apps }}"
      loop_control:
        loop_var: app_item
        label: "{{ app_item.name }}"
  when: deployer_apps | length > 0

- name: Deployer apps complete
  tags:
    - splunk
    - splunk_apps
    - deployer
  ansible.builtin.debug:
    msg: "Deployer app processing complete on {{ inventory_hostname }}"
