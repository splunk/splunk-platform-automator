---
- name: Detect Installed Splunk App
  block:
    - name: Check for potential Splunk directories
      tags:
        - splunk
        - splunk_common
      ansible.builtin.stat:
        path: "{{ splunk_install_dir }}/{{ item }}"
      loop:
        - splunk
        - splunkforwarder
      register: splunk_dirs

    - name: Set splunk_install_app based on directory existence
      tags:
        - splunk
        - splunk_common
      ansible.builtin.set_fact:
        splunk_install_app: "{{ item.item }}"
      loop: "{{ splunk_dirs.results }}"
      loop_control:
        label: "{{ item.item }}"
      when: item.stat.exists
  when: splunk_install_app is not defined

- name: Check for existing splunk install
  tags:
    - splunk
    - splunk_common
  ansible.builtin.stat:
    path: "{{splunk_install_dir}}/{{splunk_install_app}}/bin/splunk"
  register: splunk_bin_stat

- name: Set var splunk_is_installed=true
  tags:
    - splunk
    - splunk_common
  ansible.builtin.set_fact:
    splunk_is_installed: true
  when: splunk_bin_stat.stat.exists
