---
# This playbook uninstalls splunk enterprise or splunk universal forwarder

- name: Check for splunk binary
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.stat:
    path: "{{ splunk_home }}/bin/splunk"
  register: check_splunk_binary_file

- name: Check for splunk systemd unit file {{splunk_service_name}}.service
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.stat:
    path: "/etc/systemd/system/{{splunk_service_name}}.service"
  register: check_systemd_unit_file
  when:
    - use_systemctl
    - use_splunk_systemd|default(false)

- name: Stop and disable {{splunk_service_name}} service
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.service:
    name: "{{splunk_service_name}}.service"
    state: stopped
    enabled: no
  when:
    - use_systemctl
    - use_splunk_systemd|default(false)
    - check_systemd_unit_file.stat.exists

- name: Check for thp service file
  ansible.builtin.stat:
    path: "/etc/systemd/system/disable-thp.service"
  register: check_thp_systemd

- name: Call remove_disable_thp_service
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.include_tasks: remove_disable_thp_service.yml
  when:
    - use_systemctl
    - check_thp_systemd.stat.exists

- name: Check if splunk is stopped
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.shell: "pgrep splunkd"
  register: grep_result
  check_mode: no
  failed_when: "grep_result.rc > 1"
  changed_when: "grep_result.rc == 0"

- name: Kill splunk processes
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.shell: "pkill -9 -u splunk"
  # become: true
  # become_user: "{{ splunk_user }}"
  when: grep_result.rc == 0

- name: Call disable_boot-start
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.include_tasks: disable_boot-start.yml
  when:
    - use_systemctl
    - use_splunk_systemd|default(false)
    - check_systemd_unit_file.stat.exists
    - check_splunk_binary_file.stat.exists

- name: Remove init.d scripts
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
    - splunk_remove_init
  ansible.builtin.include_tasks: remove_init_and_ulimit.yml

- name: Make sure files are gone
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/etc/systemd/system/{{splunk_service_name}}.service"
    - /etc/systemd/system/disable-thp.service
    - /etc/init.d/splunk

- name: Call remove_custom_policykit
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.include_tasks: remove_custom_policykit.yml

- name: Call remove_splunk_sudoers
  tags:
    - splunk
    - splunk_software
    - splunk_upgrade
  ansible.builtin.include_tasks: remove_splunk_sudoers.yml

# Find all directories to remove, except lost+found
- name: Find files to remove all under {{splunk_home}}/
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.find:
    paths: "{{splunk_home}}/"
    file_type: any
    recurse: false
    patterns: '.*(?<!lost\+found)$'
    use_regex: true
  register: files_to_delete

# Remove as user splunk to prevent removing mounted directories
- name: Remove all under {{splunk_home}}/
  tags:
    - splunk
    - splunk_software
    - splunk_uninstall
  ansible.builtin.file:
    path: "{{item.path}}"
    state: absent
  loop: "{{ files_to_delete.files }}"
  become: true
  become_user: "{{ splunk_user }}"
# Do not remove this directory, since a mounted filesystem could be inside
#  tags:
#    - splunk
#    - splunk_software
#    - splunk_uninstall
#- name: "remove {{ splunk_home }}"
#  file:
#    path: "{{ splunk_home }}"
#    state: absent
