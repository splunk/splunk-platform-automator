---
# Verify Cluster Manager Apps
# Checks if apps are deployed to manager-apps directory correctly

- name: Initialize verification results
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.set_fact:
    cm_verification_results: []
    cm_apps_expected: []
    cm_apps_found: []
    cm_mismatches: []

- name: Filter apps for cluster manager distribution
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.set_fact:
    cm_apps_expected: "{{ cm_apps_expected + [item] }}"
  loop: "{{ splunk_app_deployment.apps | default([]) }}"
  when:
    - item.target_roles is defined
    - item.target_roles | intersect(['indexer']) | length > 0
    - item.deployment_target | default('auto') != 'direct'

- name: Check manager-apps directory exists
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.stat:
    path: "{{ splunk_home }}/etc/manager-apps"
  register: manager_apps_dir
  become: true

- name: List actual apps in manager-apps
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.find:
    paths: "{{ splunk_home }}/etc/manager-apps"
    file_type: directory
    recurse: no
  register: actual_apps
  when: manager_apps_dir.stat.exists
  become: true

- name: Extract app names from filesystem
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.set_fact:
    cm_apps_found: "{{ actual_apps.files | map(attribute='path') | map('basename') | list }}"
  when: manager_apps_dir.stat.exists and actual_apps.files is defined

- name: Verify each expected app
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.include_tasks: verify_single_app.yml
  loop: "{{ cm_apps_expected }}"
  loop_control:
    loop_var: verify_app_item
    label: "{{ verify_app_item.name }}"
  vars:
    verify_base_path: "{{ splunk_home }}/etc/manager-apps"
    verify_app_full_path: "{{ verify_app_item.target_path | default(verify_base_path ~ '/' ~ verify_app_item.name) }}"

- name: Check for unexpected apps
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.set_fact:
    cm_mismatches: "{{ cm_mismatches + [{'app': item, 'issue': 'UNEXPECTED: App exists but not in config', 'severity': 'warning'}] }}"
  loop: "{{ cm_apps_found }}"
  when:
    - cm_apps_found | length > 0
    - item not in (cm_apps_expected | map(attribute='name') | list)
    # Exclude framework/shipped apps (prefix _) and env-prefixed apps (splunk_app_prefix_); still verify if explicitly in splunk_app_deployment.apps
    - not (item is match('^_.*'))
    - not (item is match('^' + splunk_app_prefix + '_.*'))

- name: Build issues list for display
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.set_fact:
    cm_issues_display: "{{ cm_issues_display | default([]) + ['  - ' + item.app + ': ' + item.issue] }}"
  loop: "{{ cm_mismatches }}"
  when: cm_mismatches | length > 0

- name: Display verification results
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.debug:
    msg: "{{ ['=========================================', 'CLUSTER MANAGER VERIFICATION: ' + inventory_hostname, '=========================================', 'Expected apps: ' + (cm_apps_expected | map(attribute='name') | list | join(', ') if cm_apps_expected | length > 0 else '(none)'), 'Found apps: ' + (cm_apps_found | join(', ') if cm_apps_found | length > 0 else '(none)'), 'Mismatches: ' + (cm_mismatches | length | string)] + (['Issues found:'] + cm_issues_display if cm_mismatches | length > 0 else ['  âœ“ All apps deployed correctly']) + ['========================================='] }}"

- name: Fail if mismatches found and fail_on_mismatch is true
  tags:
    - splunk
    - splunk_apps
    - cluster_manager
    - verify
  ansible.builtin.fail:
    msg: "Cluster manager app verification failed: {{ cm_mismatches | length }} mismatch(es) found"
  when:
    - fail_on_mismatch | default(false) | bool
    - cm_mismatches | length > 0
