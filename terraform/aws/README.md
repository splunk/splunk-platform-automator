# AWS Terraform Configuration for Splunk Infrastructure

This directory contains Terraform configuration for provisioning EC2 instances for Splunk deployments on AWS. **Infrastructure is managed via Ansible playbooks** that generate configuration from `config/splunk_config.yml`.

## üéØ Recommended Workflow: Ansible Integration

**Use Ansible playbooks to manage infrastructure** (recommended approach):

```bash
# From the main directory
ansible-playbook ansible/provision_aws_terraform.yml
```

This approach:
- ‚úÖ Generates `terraform.tfvars` from your `splunk_config.yml`
- ‚úÖ Manages Terraform lifecycle (init, plan, apply)
- ‚úÖ Creates Ansible inventory automatically
- ‚úÖ Maintains single source of truth in config file

See [ANSIBLE_TERRAFORM_INTEGRATION.md](../ANSIBLE_TERRAFORM_INTEGRATION.md) for complete documentation.

---

## üìÅ File Structure

### Core Configuration Files

#### `main.tf` - Infrastructure Definition
Defines AWS resources:
- EC2 instances with dynamic configuration via `for_each`
- Root and additional EBS volumes (encrypted by default)
- Security group associations
- Tag management
- Data source for security group ID lookup

#### `variables.tf` - Variable Declarations
Declares all input variables with types and defaults:
- `aws_region` - AWS region (default: eu-central-1)
- `ami_id` - Amazon Machine Image ID
- `key_name` - SSH key pair name
- `ssh_username` - SSH user for connections (default: ec2-user)
- `ssh_private_key_file` - Path to private key
- `security_group_names` - Security groups (converted to IDs)
- `host_configs` - Per-host configuration (instance type, volumes, etc.)
- `tags` - Common tags for all resources

#### `terraform.tfvars` - Generated Configuration
**Auto-generated by Ansible playbook** from `config/splunk_config.yml`.

> ‚ö†Ô∏è **DO NOT EDIT MANUALLY** - Changes will be overwritten by the playbook.

#### `outputs.tf` - Output Definitions
Defines Terraform outputs:
- `ansible_inventory` - JSON inventory with all host details for Ansible

### Supporting Files

- `.terraform.lock.hcl` - Dependency lock file (commit to version control)
- `terraform.tfstate` - Current infrastructure state (**DO NOT EDIT**)
- `terraform.tfstate.backup` - Previous state backup
- `.terraform/` - Provider plugins and modules
- `tfplan` - Terraform plan file (temporary)

---

## üöÄ Quick Start (Ansible Method)

### 1. Configure Infrastructure

Edit `config/splunk_config.yml`:

```yaml
terraform:
  aws:
    region: "eu-central-1"
    ami_id: "ami-03cbad7144aeda3eb"  # Redhat 9
    key_name: "aws_key"
    ssh_private_key_file: "~/.ssh/aws_key.pem"
    ssh_username: "ec2-user"
    security_group_names: ["Splunk_Basic"]
    instance_type: "t2.micro"  # Default for all hosts
    
splunk_hosts:
  - name: idx1
    roles: [indexer]
    terraform:
      aws:
        instance_type: "c5.4xlarge"
        root_volume_size: 100
        additional_volumes:
          - device_name: "/dev/xvdb"
            volume_size: 500
            volume_type: "gp3"
```

### 2. Provision Infrastructure

```bash
# From the main directory
ansible-playbook ansible/provision_aws_terraform.yml
```

### 3. Destroy Infrastructure

```bash
ansible-playbook ansible/destroy_aws_terraform.yml
```

---

## üîß Direct Terraform Usage (Advanced)

If you need to run Terraform directly (not recommended for normal use):

```bash
cd terraform/aws

# Initialize
terraform init

# Plan
terraform plan

# Apply
terraform apply

# Destroy
terraform destroy
```

> ‚ö†Ô∏è **Note:** Direct Terraform usage bypasses Ansible integration and won't update inventory files.

---

## üìã Configuration Features

### Per-Host Configuration

Each host in `splunk_hosts` can have custom Terraform settings:

```yaml
splunk_hosts:
  - name: my-host
    terraform:
      aws:
        instance_type: "t3.large"
        root_volume_size: 100
        root_volume_type: "gp3"
        root_volume_encrypted: true
        additional_volumes:
          - device_name: "/dev/xvdb"
            volume_size: 200
            volume_type: "gp3"
            encrypted: true
        additional_tags:
          Role: "Indexer"
```

### Global Defaults

Settings in `terraform.aws` apply to all hosts unless overridden:

```yaml
terraform:
  aws:
    instance_type: "t2.micro"      # Default for all hosts
    additional_volumes:            # Default volumes for all hosts
      - device_name: "/dev/xvdb"
        volume_size: 100
```

### Host Generation with `iter`

Generate multiple hosts with numbering:

```yaml
splunk_hosts:
  # Creates idx01, idx02, idx03
  - iter:
      prefix: idx
      numbers: "01..03"
    roles: [indexer]
```

### AWS Credentials Override

Override environment variables for AWS authentication:

```yaml
terraform:
  aws:
    access_key_id: "YOUR_ACCESS_KEY"
    secret_access_key: "YOUR_SECRET_KEY"
```

---

## üì§ Outputs

After provisioning, Terraform generates:

- `inventory/hosts` - Ansible inventory file with all provisioned hosts
- Host details include:
  - `ansible_host` - Public IP/DNS
  - `ansible_user` - SSH username
  - `ansible_ssh_private_key_file` - SSH key path
  - `private_ip` - Private IP address
  - `public_ip` - Public IP address
  - DNS names (public and private)

---

## ‚ö†Ô∏è Important Notes

- **Security Groups:** Must exist in AWS before provisioning
- **SSH Keys:** EC2 key pair must exist in the specified region
- **AMI IDs:** Region-specific; update when changing regions
- **State Files:** Never manually edit Terraform state files
- **Credentials:** Configure via environment variables or in `terraform.aws` section

---

## üìö Additional Resources

- [Ansible-Terraform Integration Guide](../ANSIBLE_TERRAFORM_INTEGRATION.md)
- [Terraform AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS EC2 Instance Types](https://aws.amazon.com/ec2/instance-types/)
