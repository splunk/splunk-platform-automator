# Terraform variables auto-generated from splunk_config.yml
# Generated by Ansible playbook: provision_terraform_aws.yml
# DO NOT EDIT THIS FILE MANUALLY - Changes will be overwritten

# AWS Region
aws_region = "{{ terraform.aws.region | default('eu-central-1') }}"

# AMI Configuration
ami_id = "{{ terraform.aws.ami_id }}"

# SSH Configuration
key_name = "{{ terraform.aws.key_name }}"
ssh_private_key_file = "{{ terraform.aws.ssh_private_key_file }}"
ssh_username = "{{ terraform.aws.ssh_username | default('ec2-user') }}"

# Security Groups
security_group_names = {{ terraform.aws.security_group_names | to_json }}

# Global Tags
tags = {{ terraform.aws.tags | default({}) | to_json }}

# Host Configurations
host_configs = {
{% set ns = namespace(count=0) %}
{% for host in splunk_hosts %}
{%   if host.name is defined %}
{%     set ns.count = ns.count + 1 %}
{%   elif host.list is defined %}
{%     set ns.count = ns.count + (host.list | length) %}
{%   elif host.iter is defined %}
{%     set range_parts = host.iter.numbers.split('..') %}
{%     set start_num = range_parts[0] %}
{%     set end_num = range_parts[1] %}
{%     set ns.count = ns.count + (end_num | int - start_num | int + 1) %}
{%   endif %}
{% endfor %}
{% set ns2 = namespace(current=0) %}
{% for host in splunk_hosts %}
{%   if host.name is defined %}
{%     set hostnames = [host.name] %}
{%   elif host.list is defined %}
{%     set hostnames = host.list %}
{%   elif host.iter is defined %}
{%     set range_parts = host.iter.numbers.split('..') %}
{%     set start_num = range_parts[0] | int %}
{%     set end_num = range_parts[1] | int %}
{%     set width = range_parts[1] | length %}
{%     set hostnames = [] %}
{%     for num in range(start_num, end_num + 1) %}
{%       set padded_num = "%0{}d".format(width) | format(num) %}
{%       set hostname = (host.iter.prefix | default('')) ~ padded_num ~ (host.iter.postfix | default('')) %}
{%       set _ = hostnames.append(hostname) %}
{%     endfor %}
{%   else %}
{%     set hostnames = [] %}
{%   endif %}
{%   for hostname in hostnames %}
{%     set ns2.current = ns2.current + 1 %}
  "{{ hostname }}" = {
{% if host.terraform is defined and host.terraform.aws is defined %}
{%   set host_aws = host.terraform.aws %}
    instance_type         = "{{ host_aws.instance_type | default(terraform.aws.instance_type | default('t2.micro')) }}"
    root_volume_size      = {{ host_aws.root_volume_size | default(50) }}
    root_volume_type      = "{{ host_aws.root_volume_type | default('gp3') }}"
    root_volume_encrypted = {{ host_aws.root_volume_encrypted | default(true) | lower }}
{%   set volumes = host_aws.additional_volumes | default(terraform.aws.additional_volumes | default([])) %}
{% if volumes | length > 0 %}
    additional_volumes = [
{% for volume in volumes %}
      {
        device_name = "{{ volume.device_name }}"
        volume_size = {{ volume.volume_size }}
        volume_type = "{{ volume.volume_type | default('gp3') }}"
        encrypted   = {{ volume.encrypted | default(true) | lower }}
        delete_on_termination = {{ volume.delete_on_termination | default(true) | lower }}
      }{{ "," if not loop.last else "" }}
{% endfor %}
    ]
{% endif %}
{% if host_aws.additional_tags is defined %}
    additional_tags = {{ host_aws.additional_tags | to_json }}
{% endif %}
{% else %}
    instance_type = "{{ terraform.aws.instance_type | default('t2.micro') }}"
{%   set volumes = terraform.aws.additional_volumes | default([]) %}
{% if volumes | length > 0 %}
    additional_volumes = [
{% for volume in volumes %}
      {
        device_name = "{{ volume.device_name }}"
        volume_size = {{ volume.volume_size }}
        volume_type = "{{ volume.volume_type | default('gp3') }}"
        encrypted   = {{ volume.encrypted | default(true) | lower }}
        delete_on_termination = {{ volume.delete_on_termination | default(true) | lower }}
      }{{ "," if not loop.last else "" }}
{% endfor %}
    ]
{% endif %}
{% endif %}
  }{{ "" if ns2.current == ns.count else "," }}
{%   endfor %}
{% endfor %}
}
